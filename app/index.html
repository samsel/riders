<html>
<head>
	<link href="css/main.css" rel="stylesheet" />
	<link href="css/animate.css" rel="stylesheet" />
</head>
<body>
	<div id="info">Waiting for Players to join..</div>
	<div class="box"><iframe id="player1" src="game/game.html" class="frame"></iframe></div>
	<div class="box"><iframe id="player2" src="game/game.html" class="frame"></iframe></div>
	<div class="box"><iframe id="player3" src="game/game.html" class="frame"></iframe></div>
	<div class="box"><iframe id="player4" src="game/game.html" class="frame"></iframe></div>

	<script type="text/javascript">

		var game = (function() {

			var players = [],
				info = document.getElementById("info");

			var processEvent = function (data, id) {
				players[id].contentWindow.postMessage(JSON.stringify(data), '*');
			};

			var start = function () {
				info.innerHTML = "Game started!";
			};

			var getPlayerCount = function () {
				players = document.getElementsByTagName("iframe");
				return players.length;
			};		

			return {
				processEvent:processEvent,
				start: start,
				getPlayerCount: getPlayerCount
			};
		
		})();

		var remoteControlNetwork = (function() {

		var express = require('express'),
	  		http = require('http');
	 		app = express(),
			server = app.listen(8887),
			websocket = require('socket.io').listen(server),
			maxPlayers = game.getPlayerCount(),
			players = [];

		app.set("view options", {layout: false});

		//TODO: remove this hack code!
		app.use(express.static(process.execPath.substr(0,process.execPath.lastIndexOf('/')) + "/../../../../../../../app/remote_control"));

		app.get('/', function (req, res) {
			res.sendfile("index.html");
		});

		websocket.set('loglevel', 10);


		websocket.sockets.on("connection", function (socket) {
			if(players.length < maxPlayers) {
				players.push(socket.id);
				socket.emit("error", {
						msg: "waiting for more players to join!"
				});	
			}		
			else {
				socket.emit("error", {
					msg: "max players limit reached!"
				});				
			}

			if (players.length === maxPlayers) {
				game.start();			
			}	
			
			socket.on("event", function (data) {
				if(players.length === maxPlayers) {
					game.processEvent(data, players.indexOf(socket.id));
				}							
			});
		});

	})();

	</script>
</body>
</html>